# Sequence Diagrams - Live Scoreboard System

This document provides detailed sequence diagrams for all critical flows in the system.

---

## 1. User Registration Flow

```
┌──────┐        ┌─────────┐      ┌──────────┐      ┌─────────┐
│Client│        │   API   │      │   DB     │      │  Redis  │
└──┬───┘        └────┬────┘      └────┬─────┘      └────┬────┘
   │                 │                │                 │
   │ POST /auth/     │                │                 │
   │ register        │                │                 │
   ├────────────────>│                │                 │
   │                 │                │                 │
   │                 │ Validate input │                 │
   │                 │ (Zod schema)   │                 │
   │                 │────────┐       │                 │
   │                 │        │       │                 │
   │                 │<───────┘       │                 │
   │                 │                │                 │
   │                 │ Check username │                 │
   │                 │ uniqueness     │                 │
   │                 ├───────────────>│                 │
   │                 │                │                 │
   │                 │ User exists?   │                 │
   │                 │<───────────────┤                 │
   │                 │                │                 │
   │                 │ Hash password  │                 │
   │                 │ (bcrypt, cost12)                 │
   │                 │────────┐       │                 │
   │                 │        │       │                 │
   │                 │<───────┘       │                 │
   │                 │                │                 │
   │                 │ INSERT user    │                 │
   │                 ├───────────────>│                 │
   │                 │                │                 │
   │                 │ user_id        │                 │
   │                 │<───────────────┤                 │
   │                 │                │                 │
   │                 │ Generate JWT   │                 │
   │                 │ (RS256)        │                 │
   │                 │────────┐       │                 │
   │                 │        │       │                 │
   │                 │<───────┘       │                 │
   │                 │                │                 │
   │                 │                │ Store session   │
   │                 │                │ (user_id, JWT)  │
   │                 ├────────────────┼────────────────>│
   │                 │                │                 │
   │                 │                │ OK              │
   │                 │<───────────────┼─────────────────┤
   │                 │                │                 │
   │ 201 Created     │                │                 │
   │ {accessToken,   │                │                 │
   │  refreshToken,  │                │                 │
   │  userId}        │                │                 │
   │<────────────────┤                │                 │
   │                 │                │                 │
```

---

## 2. User Login Flow

```
┌──────┐        ┌─────────┐      ┌──────────┐      ┌─────────┐
│Client│        │   API   │      │   DB     │      │  Redis  │
└──┬───┘        └────┬────┘      └────┬─────┘      └────┬────┘
   │                 │                │                 │
   │ POST /auth/     │                │                 │
   │ login           │                │                 │
   │ {username, pwd} │                │                 │
   ├────────────────>│                │                 │
   │                 │                │                 │
   │                 │ SELECT user    │                 │
   │                 │ WHERE username │                 │
   │                 ├───────────────>│                 │
   │                 │                │                 │
   │                 │ user data      │                 │
   │                 │<───────────────┤                 │
   │                 │                │                 │
   │                 │ Verify password│                 │
   │                 │ (bcrypt.compare)                 │
   │                 │────────┐       │                 │
   │                 │        │       │                 │
   │                 │<───────┘       │                 │
   │                 │                │                 │
   │    ╔════════════╪════════════════╪═════════════════╪════════╗
   │    ║ ALT [Invalid password]      │                 │        ║
   │    ╠════════════╪════════════════╪═════════════════╪════════╣
   │    ║            │                │                 │        ║
   │    ║ 401        │                │                 │        ║
   │    ║ Unauthorized                │                 │        ║
   │<───╫────────────┤                │                 │        ║
   │    ║            │                │                 │        ║
   │    ╠════════════╪════════════════╪═════════════════╪════════╣
   │    ║ ELSE [Valid password]       │                 │        ║
   │    ╠════════════╪════════════════╪═════════════════╪════════╣
   │                 │                │                 │
   │                 │ Generate JWT   │                 │
   │                 │ access + refresh│                │
   │                 │────────┐       │                 │
   │                 │        │       │                 │
   │                 │<───────┘       │                 │
   │                 │                │                 │
   │                 │                │ Store session   │
   │                 ├────────────────┼────────────────>│
   │                 │                │                 │
   │                 │                │ OK              │
   │                 │<───────────────┼─────────────────┤
   │                 │                │                 │
   │                 │ UPDATE user    │                 │
   │                 │ SET last_login │                 │
   │                 ├───────────────>│                 │
   │                 │                │                 │
   │                 │ OK             │                 │
   │                 │<───────────────┤                 │
   │                 │                │                 │
   │ 200 OK          │                │                 │
   │ {accessToken,   │                │                 │
   │  refreshToken}  │                │                 │
   │<────────────────┤                │                 │
   │                 │                │                 │
   │    ╚════════════╧════════════════╧═════════════════╧════════╝
```

---

## 3. Action Token Request Flow

```
┌──────┐    ┌─────────┐    ┌──────────┐    ┌──────────┐    ┌─────────┐
│Client│    │   API   │    │  Auth    │    │   Redis  │    │  Fraud  │
│      │    │ Server  │    │Middleware│    │          │    │ Service │
└──┬───┘    └────┬────┘    └────┬─────┘    └────┬─────┘    └────┬────┘
   │             │              │               │               │
   │ POST /api/  │              │               │               │
   │ actions/    │              │               │               │
   │ token       │              │               │               │
   │ + JWT       │              │               │               │
   ├────────────>│              │               │               │
   │             │              │               │               │
   │             │ Validate JWT │               │               │
   │             ├─────────────>│               │               │
   │             │              │               │               │
   │             │ decoded user │               │               │
   │             │<─────────────┤               │               │
   │             │              │               │               │
   │             │              │ Check rate limit              │
   │             │              │ (10 req/min)  │               │
   │             ├──────────────┼─────────────> │               │
   │             │              │               │               │
   │             │              │ Current count │               │
   │             │<─────────────┼───────────────┤               │
   │             │              │               │               │
   │  ╔══════════╪══════════════╪═══════════════╪═══════════════╪═════╗
   │  ║ ALT [Rate limit exceeded]               │               │     ║
   │  ╠══════════╪══════════════╪═══════════════╪═══════════════╪═════╣
   │  ║          │              │               │               │     ║
   │  ║ 429 Too  │              │               │               │     ║
   │  ║ Many Req │              │               │               │     ║
   │<─╫──────────┤              │               │               │     ║
   │  ║          │              │               │               │     ║
   │  ╠══════════╪══════════════╪═══════════════╪═══════════════╪═════╣
   │  ║ ELSE [Within limit]     │               │               │     ║
   │  ╠══════════╪══════════════╪═══════════════╪═══════════════╪═════╣
   │             │              │               │               │
   │             │              │               │  Fraud check  │
   │             ├──────────────┼───────────────┼──────────────>│
   │             │              │               │               │
   │             │              │               │  No fraud     │
   │             │<─────────────┼───────────────┼ ──────────────┤
   │             │              │               │               │
   │             │ Generate nonce               │               │
   │             │ (crypto.randomBytes)         │               │
   │             │────────┐     │               │               │
   │             │        │     │               │               │
   │             │<───────┘     │               │               │
   │             │              │               │               │
   │             │ Create HMAC  │               │               │
   │             │ signature    │               │               │
   │             │ (userId:timestamp:nonce)     │               │
   │             │────────┐     │               │               │
   │             │        │     │               │               │
   │             │<───────┘     │               │               │
   │             │              │               │               │
   │             │              │ Store token   │               │
   │             │              │ (60s TTL)     │               │
   │             ├──────────────┼──────────────>│               │
   │             │              │               │               │
   │             │              │ OK            │               │
   │             │<─────────────┼───────────────┤               │
   │             │              │               │               │
   │             │              │ Increment counter             │
   │             ├──────────────┼──────────────>│               │
   │             │              │               │               │
   │             │              │ OK            │               │
   │             │<─────────────┼───────────────┤               │
   │             │              │               │               │
   │ 200 OK      │              │               │               │
   │ {actionToken}              │               │               │
   │<────────────┤              │               │               │
   │             │              │               │               │
   │  ╚══════════╧══════════════╧═══════════════╧═══════════════╧═══════╝
```

---

## 4. Score Increment Flow (Complete)

```
┌──────┐  ┌─────┐  ┌─────────┐  ┌──────────┐  ┌─────────┐  ┌──────────┐  ┌─────────┐
│Client│  │ API │  │  Token  │  │   Redis  │  │   DB    │  │ WebSocket│  │  Fraud  │
│      │  │     │  │ Service │  │          │  │         │  │  Server  │  │ Service │
└──┬───┘  └──┬──┘  └────┬────┘  └────┬─────┘  └────┬────┘  └────┬─────┘  └────┬────┘
   │         │          │            │             │            │             │
   │ POST    │          │            │             │            │             │
   │ /scores/│          │            │             │            │             │
   │ increment          │            │             │            │             │
   │ + token │          │            │             │            │             │
   ├────────>│          │            │             │            │             │
   │         │          │            │             │            │             │
   │         │ Validate │            │             │            │             │
   │         │ JWT      │            │             │            │             │
   │         │──────┐   │            │             │            │             │
   │         │      │   │            │             │            │             │
   │         │<─────┘   │            │             │            │             │
   │         │          │            │             │            │             │
   │         │ Parse &  │            │             │            │             │
   │         │ validate │            │             │            │             │
   │         │ token    │            │             │            │             │
   │         ├─────────>│            │             │            │             │
   │         │          │            │             │            │             │
   │         │          │ Check token│             │            │             │
   │         │          │ exists     │             │            │             │
   │         │          ├───────────>│             │            │             │
   │         │          │            │             │            │             │
   │         │          │ token data │             │            │             │
   │         │          │<───────────┤             │            │             │
   │         │          │            │             │            │             │
   │         │          │ Verify     │             │            │             │
   │         │          │ signature  │             │            │             │
   │         │          │──────┐     │             │            │             │
   │         │          │      │     │             │            │             │
   │         │          │<─────┘     │             │            │             │
   │         │          │            │             │            │             │
   │         │          │ Check      │             │            │             │
   │         │          │ expiration │             │            │             │
   │         │          │──────┐     │             │            │             │
   │         │          │      │     │             │            │             │
   │         │          │<─────┘     │             │            │             │
   │         │          │            │             │            │             │
   │         │ Token    │            │             │            │             │
   │         │ valid    │            │             │            │             │
   │         │<─────────┤            │             │            │             │
   │         │          │            │             │            │             │
   │         │          │ Mark token │             │            │             │
   │         │          │ as used    │             │            │             │
   │         │          ├───────────>│             │            │             │
   │         │          │            │             │            │             │
   │         │          │ OK         │             │            │             │
   │         │          │<───────────┤             │            │             │
   │         │          │            │             │            │             │
   │         │          │            │ Check rate limit         │             │
   │         │          │            │ (5 inc/min)              │             │
   │         ├────────────────────────────────────>│            │             │
   │         │          │            │             │            │             │
   │         │          │            │ count       │            │             │
   │         │<────────────────────────────────────┤            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │            │ Check fraud │
   │         ├───────────────────────────────────────────────────────────────>│
   │         │          │            │             │            │             │
   │         │          │            │             │            │ No fraud    │
   │         │<───────────────────────────────────────────────────────────────┤
   │         │          │            │             │            │             │
   │         │          │            │             │ BEGIN TRANSACTION        │
   │         ├────────────────────────────────────>│            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │ SELECT score             │
   │         │          │            │             │ FOR UPDATE               │
   │         ├────────────────────────────────────>│            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │ current score            │
   │         │<────────────────────────────────────┤            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │ UPDATE score             │
   │         │          │            │             │ SET score+1              │
   │         ├────────────────────────────────────>│            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │ OK         │             │
   │         │<────────────────────────────────────┤            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │ INSERT action            │
   │         │          │            │             │ (audit log)              │
   │         ├────────────────────────────────────>│            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │ OK         │             │
   │         │<────────────────────────────────────┤            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │ COMMIT     │             │
   │         ├────────────────────────────────────>│            │             │
   │         │          │            │             │            │             │
   │         │          │            │             │ OK         │             │
   │         │<────────────────────────────────────┤            │             │
   │         │          │            │             │            │             │
   │         │          │            │ DEL leaderboard:top10    │             │
   │         ├────────────────────────────────────>│            │             │
   │         │          │            │             │            │             │
   │         │          │            │ OK          │            │             │
   │         │<────────────────────────────────────┤            │             │
   │         │          │            │             │            │             │
   │         │          │            │ PUBLISH     │            │             │
   │         │          │            │ score_update│            │             │
   │         ├────────────────────────────────────>│            │             │
   │         │          │            │             │            │             │
   │         │          │            │ OK          │            │             │
   │         │<────────────────────────────────────┤            │             │
   │         │          │            │             │            │             │
   │ 200 OK  │          │            │             │            │             │
   │ {newScore,         │            │             │            │             │
   │  newRank}          │            │             │            │             │
   │<────────┤          │            │             │            │             │
   │         │          │            │             │            │             │
   │         │          │            │ SUBSCRIBE   │            │             │
   │         │          │            │ score_update│            │             │
   │         │          │            │<────────────────────────>│             │
   │         │          │            │             │            │             │
   │         │          │            │             │ Fetch top10│             │
   │         │          │            │<─────────────────────────┤             │
   │         │          │            │             │            │             │
   │         │          │            │ leaderboard │            │             │
   │         │          │            ├────────────────────── ──>│             │
   │         │          │            │             │            │             │
   │         │          │            │             │            │ Broadcast   │
   │         │          │            │             │            │ to all      │
   │         │          │            │             │            │ clients     │
   │         │          │            │             │            │──────┐      │
   │         │          │            │             │            │      │      │
   │         │          │            │             │            │<─────┘      │
   │         │          │            │             │            │             │
   │ WS event│          │            │             │            │             │
   │ leaderboard_update │            │             │            │             │
   │<───────────────────────────────────────────────────────────┤             │
   │         │          │            │             │            │             │
```

---

## 5. Real-Time Leaderboard Broadcasting Flow

```
┌──────────┐    ┌──────────┐    ┌─────────┐    ┌──────────┐    ┌──────────┐
│ Client 1 │    │ Client 2 │    │   WS    │    │  Redis   │    │   API    │
│          │    │          │    │ Server  │    │ Pub/Sub  │    │  Server  │
└────┬─────┘    └────┬─────┘    └────┬────┘    └────┬─────┘    └────┬─────┘
     │               │               │              │               │
     │ WS Connect    │               │              │               │
     ├──────────────────────────────>│              │               │
     │               │               │              │               │
     │               │               │ Authenticate │               │
     │               │               │ JWT          │               │
     │               │               │──────┐       │               │
     │               │               │      │       │               │
     │               │               │<─────┘       │               │
     │               │               │              │               │
     │               │               │ JOIN room    │               │
     │               │               │ 'leaderboard'│               │
     │               │               │──────┐       │               │
     │               │               │      │       │               │
     │               │               │<─────┘       │               │
     │               │               │              │               │
     │ Connected     │               │              │               │
     │<──────────────────────────────┤              │               │
     │               │               │              │               │
     │               │ WS Connect    │              │               │
     │               ├──────────────>│              │               │
     │               │               │              │               │
     │               │               │ Authenticate │               │
     │               │               │ JWT          │               │
     │               │               │──────┐       │               │
     │               │               │      │       │               │
     │               │               │<─────┘       │               │
     │               │               │              │               │
     │               │               │ JOIN room    │               │
     │               │               │ 'leaderboard'│               │
     │               │               │──────┐       │               │
     │               │               │      │       │               │
     │               │               │<─────┘       │               │
     │               │               │              │               │
     │               │ Connected     │              │               │
     │               │<──────────────┤              │               │
     │               │               │              │               │
     │               │               │              │ Score update  │
     │               │               │              │ occurs        │
     │               │               │              │<──────────────┤
     │               │               │              │               │
     │               │               │              │ PUBLISH       │
     │               │               │              │ 'score_update'
     │               │               │              │<──────────────┤
     │               │               │              │               │
     │               │               │ SUBSCRIBE    │               │
     │               │               │<─────────────┤               │
     │               │               │              │               │
     │               │               │ Message:     │               │
     │               │               │ score_update │               │
     │               │               │<─────────────┤               │
     │               │               │              │               │
     │               │               │ Fetch top10  │               │
     │               │               ├─────────────────────────────>│
     │               │               │              │               │
     │               │               │              │ Query Redis   │
     │               │               │              │<──────────────┤
     │               │               │              │               │
     │               │               │              │ Cache miss    │
     │               │               │              ├──────────────>│
     │               │               │              │               │
     │               │               │              │ Query DB      │
     │               │               │              │──────┐        │
     │               │               │              │      │        │
     │               │               │              │<─────┘        │
     │               │               │              │               │
     │               │               │ leaderboard  │               │
     │               │               │<─────────────────────────────┤
     │               │               │              │               │
     │               │               │ EMIT to room │               │
     │               │               │ 'leaderboard'│               │
     │               │               │──────┐       │               │
     │               │               │      │       │               │
     │               │               │<─────┘       │               │
     │               │               │              │               │
     │ leaderboard_  │               │              │               │
     │ update event  │               │              │               │
     │<──────────────────────────────┤              │               │
     │               │               │              │               │
     │               │ leaderboard_  │              │               │
     │               │ update event  │              │               │
     │               │<──────────────┤              │               │
     │               │               │              │               │
     │ Update UI     │               │              │               │
     │──────┐        │               │              │               │
     │      │        │               │              │               │
     │<─────┘        │               │              │               │
     │               │               │              │               │
     │               │ Update UI     │              │               │
     │               │──────┐        │              │               │
     │               │      │        │              │               │
     │               │<─────┘        │              │               │
     │               │               │              │               │
```

---

## 6. Fraud Detection Flow

```
┌──────┐    ┌─────────┐    ┌─────────┐    ┌──────────┐    ┌─────────┐
│Client│    │   API   │    │  Fraud  │    │   Redis  │    │   DB    │
│      │    │ Server  │    │ Service │    │          │    │         │
└──┬───┘    └────┬────┘    └────┬────┘    └────┬─────┘    └────┬────┘
   │             │              │              │               │
   │ Score       │              │              │               │
   │ increment   │              │              │               │
   │ request     │              │              │               │
   ├────────────>│              │              │               │
   │             │              │              │               │
   │             │ Evaluate     │              │               │
   │             │ fraud rules  │              │               │
   │             ├─────────────>│              │               │
   │             │              │              │               │
   │             │              │ Get recent   │               │
   │             │              │ actions (10s)│               │
   │             │              ├─────────────>│               │
   │             │              │              │               │
   │             │              │ action count │               │
   │             │              │<─────────────┤               │
   │             │              │              │               │
   │             │              │ Rule 1:      │               │
   │             │              │ Rapid requests               │
   │             │              │ (>8 in 10s?) │               │
   │             │              │──────┐       │               │
   │             │              │      │       │               │
   │             │              │<─────┘       │               │
   │             │              │              │               │
   │  ╔══════════╪══════════════╪══════════════╪═══════════════╪═════════╗
   │  ║ ALT [Fraud detected]    │              │               │         ║
   │  ╠══════════╪══════════════╪══════════════╪═══════════════╪═════════╣
   │             │              │              │               │
   │             │              │ Log fraud    │               │
   │             │              │ event        │               │
   │             │              ├──────────────┼──────────────>│
   │             │              │              │               │
   │             │              │ OK           │               │
   │             │              │<─────────────┼───────────────┤
   │             │              │              │               │
   │             │              │ Get fraud    │               │
   │             │              │ count (user) │               │
   │             │              ├──────────────┼──────────────>│
   │             │              │              │               │
   │             │              │ count        │               │
   │             │              │<─────────────┼───────────────┤
   │             │              │              │               │
   │             │              │ Determine    │               │
   │             │              │ action       │               │
   │             │              │──────┐       │               │
   │             │              │      │       │               │
   │             │              │<─────┘       │               │
   │             │              │              │               │
   │  ╔══════════╪══════════════╪══════════════╪═══════════════╪═════════╗
   │  ║ ALT [Action: FLAG]      │              │               │         ║
   │  ╠══════════╪══════════════╪══════════════╪═══════════════╪═════════╣
   │             │              │              │               │
   │             │              │ Flag user    │               │
   │             │              ├──────────────┼──────────────>│
   │             │              │              │               │
   │             │              │ OK           │               │
   │             │              │<─────────────┼───────────────┤
   │             │              │              │               │
   │             │              │ Reduce rate  │               │
   │             │              │ limits       │               │
   │             │              ├─────────────>│               │
   │             │              │              │               │
   │             │              │ OK           │               │
   │             │              │<─────────────┤               │
   │             │              │              │               │
   │             │ Fraud        │              │               │
   │             │ detected:    │              │               │
   │             │ FLAG         │              │               │
   │             │<─────────────┤              │               │
   │             │              │              │               │
   │ 200 OK      │              │              │               │
   │ (proceed    │              │              │               │
   │ with warning)              │              │               │
   │<────────────┤              │              │               │
   │             │              │              │               │
   │  ╠══════════╪══════════════╪══════════════╪═══════════════╪═════════╣
   │  ║ ALT [Action: BAN]       │              │               │         ║
   │  ╠══════════╪══════════════╪══════════════╪═══════════════╪═════════╣
   │             │              │              │               │
   │             │              │ Ban user     │               │
   │             │              ├──────────────┼──────────────>│
   │             │              │              │               │
   │             │              │ OK           │               │
   │             │              │<─────────────┼───────────────┤
   │             │              │              │               │
   │             │              │ Blacklist    │               │
   │             │              │ JWT          │               │
   │             │              ├─────────────>│               │
   │             │              │              │               │
   │             │              │ OK           │               │
   │             │              │<─────────────┤               │
   │             │              │              │               │
   │             │ Fraud        │              │               │
   │             │ detected:    │              │               │
   │             │ BAN          │              │               │
   │             │<─────────────┤              │               │
   │             │              │              │               │
   │ 403         │              │              │               │
   │ Forbidden   │              │              │               │
   │ (banned)    │              │              │               │
   │<────────────┤              │              │               │
   │             │              │              │               │
   │  ╠══════════╪══════════════╪══════════════╪═══════════════╪═════════╣
   │  ║ ELSE [No fraud]         │              │               │         ║
   │  ╠══════════╪══════════════╪══════════════╪═══════════════╪═════════╣
   │             │              │              │               │
   │             │ No fraud     │              │               │
   │             │<─────────────┤              │               │
   │             │              │              │               │
   │             │ Continue     │              │               │
   │             │ processing   │              │               │
   │             │──────┐       │              │               │
   │             │      │       │              │               │
   │             │<─────┘       │              │               │
   │             │              │              │               │
   │  ╚══════════╧══════════════╧══════════════╧═══════════════╧═════════╝
   │  ╚══════════╧══════════════╧══════════════╧═══════════════╧═════════╝
```

---

## 7. Cache Invalidation Flow

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌──────────┐    ┌──────────┐
│   API   │    │  Redis  │    │  Redis  │    │   API    │    │   API    │
│ Server 1│    │ Primary │    │ Pub/Sub │    │ Server 2 │    │ Server 3 │
└────┬────┘    └────┬────┘    └────┬────┘    └────┬─────┘    └────┬─────┘
     │              │              │              │               │
     │ Score update │              │              │               │
     │ committed    │              │              │               │
     │──────┐       │              │              │               │
     │      │       │              │              │               │
     │<─────┘       │              │              │               │
     │              │              │              │               │
     │ DEL          │              │              │               │
     │ leaderboard: │              │              │               │
     │ top10        │              │              │               │
     ├─────────────>│              │              │               │
     │              │              │              │               │
     │ OK           │              │              │               │
     │<─────────────┤              │              │               │
     │              │              │              │               │
     │ Delete       │              │              │               │
     │ L1 cache     │              │              │               │
     │ (memory)     │              │              │               │
     │──────┐       │              │              │               │
     │      │       │              │              │               │
     │<─────┘       │              │              │               │
     │              │              │              │               │
     │ PUBLISH      │              │              │               │
     │ cache:       │              │              │               │
     │ invalidate   │              │              │               │
     ├────────────────────────────>│              │               │
     │              │              │              │               │
     │ OK           │              │              │               │
     │<────────────────────────────┤              │               │
     │              │              │              │               │
     │              │              │ SUBSCRIBE    │               │
     │              │              │<─────────────┤               │
     │              │              │              │               │
     │              │              │ Message:     │               │
     │              │              │ cache:       │               │
     │              │              │ invalidate   │               │
     │              │              ├─────────────>│               │
     │              │              │              │               │
     │              │              │              │ Delete L1     │
     │              │              │              │ cache         │
     │              │              │              │──────┐        │
     │              │              │              │      │        │
     │              │              │              │<─────┘        │
     │              │              │              │               │
     │              │              │ SUBSCRIBE    │               │
     │              │              │<──────────────────────────────
     │              │              │              │               │
     │              │              │ Message:     │               │
     │              │              │ cache:       │               │
     │              │              │ invalidate   │               │
     │              │              ├──────────────────────────────>
     │              │              │              │               │
     │              │              │              │               │ Delete L1
     │              │              │              │               │ cache
     │              │              │              │               │──────┐
     │              │              │              │               │      │
     │              │              │              │               │<─────┘
     │              │              │              │               │
     │              │              │              │               │
     │ [Next request]              │              │               │
     │              │              │              │               │
     │ GET          │              │              │               │
     │ leaderboard: │              │              │               │
     │ top10        │              │              │               │
     ├─────────────>│              │              │               │
     │              │              │              │               │
     │ Cache miss   │              │              │               │
     │<─────────────┤              │              │               │
     │              │              │              │               │
     │ Query DB     │              │              │               │
     │──────┐       │              │              │               │
     │      │       │              │              │               │
     │<─────┘       │              │              │               │
     │              │              │              │               │
     │ SET          │              │              │               │
     │ leaderboard: │              │              │               │
     │ top10        │              │              │               │
     │ (5s TTL)     │              │              │               │
     ├─────────────>│              │              │               │
     │              │              │              │               │
     │ OK           │              │              │               │
     │<─────────────┤              │              │               │
     │              │              │              │               │
```

---

## 8. Error Handling Flow

```
┌──────┐        ┌─────────┐      ┌──────────┐      ┌─────────┐
│Client│        │   API   │      │   Redis  │      │   DB    │
└──┬───┘        └────┬────┘      └────┬─────┘      └────┬────┘
   │                 │                │                 │
   │ Score increment │                │                 │
   ├────────────────>│                │                 │
   │                 │                │                 │
   │                 │ Validate token │                 │
   │                 ├───────────────>│                 │
   │                 │                │                 │
   │                 │ Token not found│                 │
   │                 │<───────────────┤                 │
   │                 │                │                 │
   │  ╔══════════════╪════════════════╪═════════════════╪════════╗
   │  ║ TRY [Process request]         │                 │        ║
   │  ╠══════════════╪════════════════╪═════════════════╪════════╣
   │                 │                │                 │        ║
   │                 │ throw          │                 │        ║
   │                 │ InvalidToken   │                 │        ║
   │                 │ Error          │                 │        ║
   │                 │────────┐       │                 │        ║
   │                 │        │       │                 │        ║
   │                 │<───────┘       │                 │        ║
   │                 │                │                 │        ║
   │  ╠══════════════╪════════════════╪═════════════════╪════════╣
   │  ║ CATCH [InvalidTokenError]     │                 │        ║
   │  ╠══════════════╪════════════════╪═════════════════╪════════╣
   │                 │                │                 │        ║
   │                 │ Log error      │                 │        ║
   │                 │ (Winston)      │                 │        ║
   │                 │────────┐       │                 │        ║
   │                 │        │       │                 │        ║
   │                 │<───────┘       │                 │        ║
   │                 │                │                 │        ║
   │                 │ Increment      │                 │        ║
   │                 │ error metric   │                 │        ║
   │                 │ (Prometheus)   │                 │        ║
   │                 │────────┐       │                 │        ║
   │                 │        │       │                 │        ║
   │                 │<───────┘       │                 │        ║
   │                 │                │                 │        ║
   │ 400 Bad Request │                │                 │        ║
   │ {               │                │                 │        ║
   │   error: "Invalid token",        │                 │        ║
   │   code: "TOKEN_INVALID",         │                 │        ║
   │   message: "Token not found"     │                 │        ║
   │ }               │                │                 │        ║
   │<────────────────┤                │                 │        ║
   │                 │                │                 │        ║
   │  ╠══════════════╪════════════════╪═════════════════╪════════╣
   │  ║ CATCH [DatabaseError]         │                 │        ║
   │  ╠══════════════╪════════════════╪═════════════════╪════════╣
   │                 │                │                 │        ║
   │                 │ Log error      │                 │        ║
   │                 │ with stack     │                 │        ║
   │                 │────────┐       │                 │        ║
   │                 │        │       │                 │        ║
   │                 │<───────┘       │                 │        ║
   │                 │                │                 │        ║
   │                 │ Send alert     │                 │        ║
   │                 │ to ops team    │                 │        ║
   │                 │────────┐       │                 │        ║
   │                 │        │       │                 │        ║
   │                 │<───────┘       │                 │        ║
   │                 │                │                 │        ║
   │ 500 Internal    │                │                 │        ║
   │ Server Error    │                │                 │        ║
   │ {               │                │                 │        ║
   │   error: "Database error",       │                 │        ║
   │   code: "DB_ERROR",              │                 │        ║
   │   requestId: "req_12345"         │                 │        ║
   │ }               │                │                 │        ║
   │<────────────────┤                │                 │        ║
   │                 │                │                 │        ║
   │  ╚══════════════╧════════════════╧═════════════════╧════════╝
```

---

## 9. Health Check Flow

```
┌──────────────┐    ┌─────────┐    ┌──────────┐    ┌─────────┐
│Load Balancer │    │   API   │    │   Redis  │    │   DB    │
└──────┬───────┘    └────┬────┘    └────┬─────┘    └────┬────┘
       │                 │              │               │
       │ GET /health     │              │               │
       ├────────────────>│              │               │
       │                 │              │               │
       │                 │ Check Redis  │               │
       │                 ├─────────────>│               │
       │                 │              │               │
       │                 │ PING → PONG  │               │
       │                 │<─────────────┤               │
       │                 │              │               │
       │                 │ Check DB     │               │
       │                 ├──────────────┼──────────────>│
       │                 │              │               │
       │                 │ SELECT 1 → 1 │               │
       │                 │<─────────────┼───────────────┤
       │                 │              │               │
       │                 │ Check        │               │
       │                 │ dependencies │               │
       │                 │────────┐     │               │
       │                 │        │     │               │
       │                 │<───────┘     │               │
       │                 │              │               │
       │ 200 OK          │              │               │
       │ {               │              │               │
       │   status: "healthy",           │               │
       │   redis: "ok",  │              │               │
       │   database: "ok",              │               │
       │   uptime: 12345,│              │               │
       │   timestamp: ...│              │               │
       │ }               │              │               │
       │<────────────────┤              │               │
       │                 │              │               │
       │                 │              │               │
       │ [If dependency fails]          │               │
       │                 │              │               │
       │ GET /health     │              │               │
       ├────────────────>│              │               │
       │                 │              │               │
       │                 │ Check Redis  │               │
       │                 ├─────────────>│               │
       │                 │              │               │
       │                 │ Timeout      │               │
       │                 │<─────────────┤               │
       │                 │              │               │
       │ 503 Service     │              │               │
       │ Unavailable     │              │               │
       │ {               │              │               │
       │   status: "unhealthy",         │               │
       │   redis: "timeout",            │               │
       │   database: "ok",              │               │
       │   timestamp: ...│              │               │
       │ }               │              │               │
       │<────────────────┤              │               │
       │                 │              │               │
```

---

## 10. Graceful Shutdown Flow

```
┌──────────┐    ┌─────────┐    ┌──────────┐    ┌─────────┐    ┌─────────┐
│   OS     │    │   API   │    │ WebSocket│    │  Redis  │    │   DB    │
│ (SIGTERM)│    │ Server  │    │  Server  │    │         │    │         │
└────┬─────┘    └────┬────┘    └────┬─────┘    └───┬─────┘    └───┬─────┘
     │               │              │              │              │
     │ SIGTERM       │              │              │              │
     ├──────────────>│              │              │              │
     │               │              │              │              │
     │               │ Log shutdown │              │              │
     │               │ initiated    │              │              │
     │               │──────┐       │              │              │
     │               │      │       │              │              │
     │               │<─────┘       │              │              │
     │               │              │              │              │
     │               │ Stop accepting              │              │
     │               │ new requests │              │              │
     │               │──────┐       │              │              │
     │               │      │       │              │              │
     │               │<─────┘       │              │              │
     │               │              │              │              │
     │               │ Notify clients              │              │
     │               │ of shutdown  │              │              │
     │               ├─────────────>│              │              │
     │               │              │              │              │
     │               │              │ Emit         │              │
     │               │              │ 'disconnect' │              │
     │               │              │ to all       │              │
     │               │              │──────┐       │              │
     │               │              │      │       │              │
     │               │              │<─────┘       │              │
     │               │              │              │              │
     │               │ Wait for     │              │              │
     │               │ in-flight    │              │              │
     │               │ requests     │              │              │
     │               │ (max 30s)    │              │              │
     │               │──────┐       │              │              │
     │               │      │       │              │              │
     │               │<─────┘       │              │              │
     │               │              │              │              │
     │               │ Close Redis  │              │              │
     │               │ connections  │              │              │
     │               ├──────────────┼─────────────>│              │
     │               │              │              │              │
     │               │              │ Close        │              │
     │               │<─────────────┼──────────────┤              │
     │               │              │              │              │
     │               │ Close DB     │              │              │
     │               │ connections  │              │              │
     │               ├──────────────┼──────────────┼─────────────>│
     │               │              │              │              │
     │               │              │              │ Close pool   │
     │               │<─────────────┼──────────────┼──────────────┤
     │               │              │              │              │
     │               │ Flush logs   │              │              │
     │               │──────┐       │              │              │
     │               │      │       │              │              │
     │               │<─────┘       │              │              │
     │               │              │              │              │
     │               │ Exit process │              │              │
     │               │ (code 0)     │              │              │
     │               │──────┐       │              │              │
     │               │      │       │              │              │
     │               │<─────┘       │              │              │
     │               │              │              │              │
     │ Process exits │              │              │              │
     │<──────────────┤              │              │              │
     │               │              │              │              │
```

---
